<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Player</title>
    <meta name="theme-color" content="#000000">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #000; color: #e5e5e5; font-family: sans-serif; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .aspect-vertical { aspect-ratio: 9/16; max-height: 85vh; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .expanded { -webkit-line-clamp: unset; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <nav class="fixed top-0 w-full bg-black/60 backdrop-blur z-50 h-14 flex items-center px-4 justify-between">
        <a href="/" class="text-white flex items-center gap-2 hover:text-red-500 transition">
            <i class="fas fa-chevron-left"></i> <span class="font-bold text-sm">Kembali</span>
        </a>
        <select id="quality-select" class="bg-zinc-800/80 text-xs text-white border border-zinc-600 rounded px-2 py-1 outline-none hidden"></select>
    </nav>

    <main class="flex-1 flex flex-col items-center pt-14 pb-10 w-full">
        <div class="w-full max-w-2xl px-0 sm:px-4">
            
            <div class="w-full bg-black relative group aspect-vertical rounded-xl overflow-hidden ring-1 ring-zinc-800 shadow-2xl mx-auto">
                <video id="video-el" controls autoplay playsinline class="w-full h-full object-contain bg-black" referrerpolicy="no-referrer" preload="auto"></video>
                <div id="loader" class="absolute inset-0 flex items-center justify-center bg-black z-10">
                    <div class="text-center"><i class="fas fa-circle-notch fa-spin text-red-600 text-4xl mb-2"></i><p class="text-xs text-gray-500">Memuat...</p></div>
                </div>
            </div>

            <div class="mt-5 px-4 sm:px-0">
                <div class="flex justify-between items-start gap-2">
                    <h1 id="title" class="text-lg font-bold text-white leading-snug flex-1">...</h1>
                    <button onclick="toggleFav()" id="fav-btn" class="text-gray-500 text-xl"><i class="far fa-heart"></i></button>
                </div>

                <div class="flex items-center mt-4 gap-3 bg-zinc-900/50 p-2 rounded-xl border border-zinc-800">
                    <a id="btn-prev" class="flex-1 py-2.5 bg-zinc-800 rounded-lg text-center text-xs font-bold text-gray-400 disabled:opacity-50"><i class="fas fa-step-backward"></i> Prev</a>
                    <div class="text-center px-2"><span class="text-[10px] text-gray-500 block">EPISODE</span><span id="ep-idx" class="text-white text-lg font-bold leading-none">-</span></div>
                    <a id="btn-next" class="flex-[2] py-2.5 bg-red-600 rounded-lg text-center text-sm font-bold text-white">Lanjut <i class="fas fa-step-forward"></i></a>
                </div>

                <div class="mt-4 p-4 bg-zinc-900 rounded-xl border border-zinc-800/50">
                    <p id="desc" class="text-sm text-gray-400 leading-relaxed line-clamp-3 cursor-pointer" onclick="this.classList.toggle('line-clamp-3')"></p>
                </div>

                <div class="mt-6">
                    <h3 class="text-xs uppercase text-gray-500 font-bold mb-3">Daftar Episode</h3>
                    <div id="ep-grid" class="grid grid-cols-5 gap-2 max-h-60 overflow-y-auto hide-scroll pr-1"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API = "/api/data";
        const pathParts = window.location.pathname.split('/'); 
        const bookId = pathParts[2]; 
        const epIndex = parseInt(pathParts[3]) || 1;

        const getLS = (k) => JSON.parse(localStorage.getItem(k)||'{}');
        const setLS = (k,v) => localStorage.setItem(k, JSON.stringify(v));
        let currentInfo = null;

        async function init() {
            if(!bookId) return;
            try {
                const res = await fetch(`${API}?type=chapter&bookId=${bookId}`);
                const json = await res.json();
                if(json.error) throw new Error(json.error);
                
                const chapters = json.chapters || [];
                const currentChap = chapters.find(c => c.index === epIndex) || chapters[0];
                currentInfo = json.info || {};

                // Save History
                const hist = getLS('db_history');
                hist[bookId] = { id: bookId, title: currentInfo.title, cover: currentInfo.cover, episodes: currentInfo.totalEps, lastEpisode: epIndex, timestamp: Date.now() };
                setLS('db_history', hist);

                renderUI(json, currentChap, chapters);
            } catch(e) {
                document.getElementById('loader').innerHTML = `<div class="text-red-500 text-center">${e.message}</div>`;
            }
        }

        function renderUI(data, currentChap, chapters) {
            const vid = document.getElementById('video-el');
            const qSelect = document.getElementById('quality-select');
            
            // Video
            if(currentChap.sources && currentChap.sources.length) {
                qSelect.classList.remove('hidden');
                qSelect.innerHTML = currentChap.sources.map(s => `<option value="${s.url}">${s.q}p</option>`).join('');
                vid.src = currentChap.sources[0].url;
                qSelect.onchange = (e) => { const t=vid.currentTime; vid.src=e.target.value; vid.currentTime=t; vid.play(); }
            } else {
                vid.src = currentChap.url;
            }
            vid.poster = data.info.cover;
            vid.oncanplay = () => document.getElementById('loader').classList.add('hidden');
            vid.onended = () => {
                if(epIndex < chapters.length) window.location.href = `/player/${bookId}/${epIndex+1}`;
            };

            // Info
            document.getElementById('title').innerText = data.info.title;
            document.getElementById('desc').innerText = data.info.desc;
            document.getElementById('ep-idx').innerText = currentChap.index;

            // Nav Buttons
            const prev = document.getElementById('btn-prev');
            const next = document.getElementById('btn-next');
            if(epIndex > 1) prev.href = `/player/${bookId}/${epIndex-1}`; else prev.classList.add('opacity-50','pointer-events-none');
            if(epIndex < chapters.length) next.href = `/player/${bookId}/${epIndex+1}`; else next.classList.add('opacity-50','pointer-events-none');

            // Grid
            document.getElementById('ep-grid').innerHTML = chapters.map(ch => 
                `<a href="/player/${bookId}/${ch.index}" class="block text-center py-2 rounded text-xs font-bold border ${ch.index===epIndex ? 'bg-red-600 border-red-600 text-white' : 'bg-zinc-800 border-zinc-700 text-gray-400'}">${ch.index}</a>`
            ).join('');
            
            updateFavBtn();
        }

        function toggleFav() {
            const favs = getLS('db_favs');
            if(favs[bookId]) delete favs[bookId];
            else favs[bookId] = { id: bookId, title: currentInfo.title, cover: currentInfo.cover, episodes: currentInfo.totalEps };
            setLS('db_favs', favs);
            updateFavBtn();
        }

        function updateFavBtn() {
            const favs = getLS('db_favs');
            const btn = document.getElementById('fav-btn');
            btn.innerHTML = favs[bookId] ? '<i class="fas fa-heart text-red-600"></i>' : '<i class="far fa-heart"></i>';
        }

        init();
    </script>
</body>
</html>
