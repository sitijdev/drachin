<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dramabox Unofficial</title>
    <meta name="description" content="Nonton drama pendek sub Indo gratis.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0f0f0f; color: #e5e5e5; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .aspect-poster { aspect-ratio: 2/3; }
        .glass-nav { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px); }
    </style>
</head>
<body class="antialiased pb-20 font-sans">

    <nav class="fixed top-0 w-full glass-nav z-50 border-b border-white/5">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between gap-4">
            <a href="/" onclick="event.preventDefault(); goHome()" class="flex items-center gap-2 shrink-0">
                <i class="fas fa-play-circle text-red-600 text-2xl"></i>
                <span class="font-bold text-lg hidden sm:block tracking-wide">DRAMABOX</span>
            </a>
            
            <form onsubmit="handleSearch(event)" class="flex-1 max-w-md relative">
                <input id="search-input" type="text" placeholder="Cari drama..." 
                    class="w-full bg-white/10 border border-white/10 rounded-full py-2 px-5 pl-10 text-sm text-white focus:outline-none focus:bg-white/20 transition">
                <i class="fas fa-search absolute left-3.5 top-2.5 text-gray-400 text-sm"></i>
            </form>

            <div id="loading" class="hidden text-red-500"><i class="fas fa-circle-notch fa-spin"></i></div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto mt-20 min-h-screen px-4">
        
        <div id="view-home" class="space-y-8 animate-fade-in"></div>

        <div id="view-detail" class="hidden">
            <button onclick="goHome()" class="mb-4 flex items-center gap-2 text-gray-400 hover:text-white transition">
                <i class="fas fa-arrow-left"></i> Kembali
            </button>

            <div class="flex flex-col md:flex-row gap-6 items-start">
                <div class="w-full md:w-64 shrink-0">
                    <div class="aspect-poster rounded-xl overflow-hidden shadow-2xl border border-white/10 relative">
                        <img id="d-cover" src="" class="w-full h-full object-cover">
                        <div class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow">HD</div>
                    </div>
                </div>
                
                <div class="flex-1 w-full">
                    <h1 id="d-title" class="text-2xl md:text-4xl font-bold text-white mb-3 leading-tight"></h1>
                    <div class="flex flex-wrap gap-2 mb-4" id="d-tags"></div>
                    
                    <div class="flex items-center gap-6 text-sm text-gray-400 mb-6 border-y border-white/10 py-3">
                        <span><i class="fas fa-list-ol text-red-500 mr-1"></i> <span id="d-eps">0</span> Episode</span>
                        <span><i class="fas fa-closed-captioning text-red-500 mr-1"></i> Sub Indo</span>
                    </div>

                    <p id="d-desc" class="text-gray-300 text-sm leading-relaxed mb-6"></p>

                    <div>
                        <h3 class="text-white font-bold mb-3 flex items-center gap-2">
                            <i class="fas fa-play-circle text-red-600"></i> Pilih Episode
                        </h3>
                        <div id="d-chapters" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 max-h-96 overflow-y-auto pr-1 custom-scroll">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="player-overlay" class="hidden fixed inset-0 z-[100] bg-black flex items-center justify-center backdrop-blur-xl">
        <div class="w-full h-full max-w-screen-lg max-h-screen aspect-[9/16] sm:aspect-video bg-black relative shadow-2xl">
            <video id="vid-player" controls autoplay playsinline class="w-full h-full object-contain"></video>
            <button onclick="closePlayer()" class="absolute top-4 right-4 bg-white/10 hover:bg-red-600 text-white p-2 rounded-full transition backdrop-blur">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
    </div>

    <script>
        const API = "/api/data";
        let homeData = null;

        // Init
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('drama')) {
                // Load detail directly if shared link
                // (Butuh fetch list dulu untuk data lengkap, atau buat endpoint detail khusus)
                loadHomeData().then(() => {
                   const b = findBook(params.get('drama'));
                   if(b) openDetail(b, false);
                });
            } else {
                loadHomeData();
            }
        };

        window.onpopstate = (e) => {
            if(e.state?.view === 'detail') renderDetail(e.state.data);
            else goHome(false);
        };

        async function loadHomeData() {
            showLoading(true);
            try {
                const res = await fetch(`${API}?type=list`);
                const json = await res.json();
                homeData = json.sections || [];
                renderList(homeData);
            } catch(e) { alert("Gagal memuat data"); }
            showLoading(false);
        }

        async function handleSearch(e) {
            e.preventDefault();
            const query = document.getElementById('search-input').value;
            if(!query) return;

            showLoading(true);
            try {
                const res = await fetch(`${API}?type=search&keyword=${encodeURIComponent(query)}`);
                const json = await res.json();
                if(json.sections) renderList(json.sections);
                else alert("Tidak ditemukan");
            } catch(e) { console.error(e); }
            showLoading(false);
            
            // Reset view to home
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('view-detail').classList.add('hidden');
        }

        function renderList(sections) {
            const container = document.getElementById('view-home');
            container.innerHTML = '';

            sections.forEach(sec => {
                if(!sec.books.length) return;
                const section = document.createElement('div');
                section.innerHTML = `
                    <h2 class="text-xl font-bold text-white mb-4 border-l-4 border-red-600 pl-3">${sec.title}</h2>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3 sm:gap-4">
                        ${sec.books.map(b => `
                            <div onclick="selectBook('${encodeURIComponent(JSON.stringify(b))}')" 
                                 class="group cursor-pointer relative">
                                <div class="aspect-poster rounded-lg overflow-hidden bg-zinc-800 mb-2 ring-1 ring-white/10 group-hover:ring-red-600 transition">
                                    <img src="${b.cover}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" loading="lazy">
                                    <div class="absolute top-1 right-1 bg-black/80 backdrop-blur text-[10px] px-1.5 py-0.5 rounded text-white font-bold shadow">${b.episodes} Eps</div>
                                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                                        <i class="fas fa-play-circle text-4xl text-red-600 drop-shadow-lg transform scale-50 group-hover:scale-100 transition"></i>
                                    </div>
                                </div>
                                <h3 class="text-xs sm:text-sm font-medium text-gray-300 group-hover:text-white line-clamp-2 leading-tight">${b.title}</h3>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            });
        }

        window.selectBook = (str) => openDetail(JSON.parse(decodeURIComponent(str)));

        function openDetail(book, push = true) {
            if(push) history.pushState({view: 'detail', data: book}, book.title, `?drama=${book.id}`);
            renderDetail(book);
        }

        function renderDetail(book) {
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            window.scrollTo(0,0);

            document.getElementById('d-title').innerText = book.title;
            document.getElementById('d-desc').innerText = book.desc;
            document.getElementById('d-cover').src = book.cover;
            document.getElementById('d-eps').innerText = book.episodes;
            
            const tags = document.getElementById('d-tags');
            if(book.tags) tags.innerHTML = book.tags.map(t => `<span class="bg-white/10 text-xs px-2 py-1 rounded text-gray-300 border border-white/5">${t}</span>`).join('');

            // Load Episodes
            const grid = document.getElementById('d-chapters');
            grid.innerHTML = '<div class="col-span-full py-12 text-center text-gray-500 animate-pulse">Sedang memuat video...</div>';

            fetch(`${API}?type=chapter&bookId=${book.id}`)
                .then(r => r.json())
                .then(json => {
                    grid.innerHTML = '';
                    if(json.error) {
                        grid.innerHTML = `<div class="col-span-full text-center text-red-500 bg-red-900/10 p-4 rounded border border-red-900/50">${json.error}</div>`;
                        return;
                    }
                    if(json.chapters) {
                        json.chapters.forEach(ch => {
                            const btn = document.createElement('button');
                            btn.className = "bg-zinc-800 hover:bg-red-600 text-gray-300 hover:text-white py-2.5 rounded font-bold text-sm transition border border-white/5 hover:border-red-500";
                            btn.innerText = ch.index;
                            btn.onclick = () => playVideo(ch.url);
                            grid.appendChild(btn);
                        });
                    }
                });
        }

        function playVideo(url) {
            const v = document.getElementById('vid-player');
            v.src = url;
            document.getElementById('player-overlay').classList.remove('hidden');
            v.play();
        }

        window.closePlayer = () => {
            const v = document.getElementById('vid-player');
            v.pause(); v.src = '';
            document.getElementById('player-overlay').classList.add('hidden');
        }

        window.goHome = (push = true) => {
            if(push) history.pushState({view: 'home'}, 'Home', '/');
            document.getElementById('view-detail').classList.add('hidden');
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('search-input').value = '';
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function findBook(id) {
            if(!homeData) return null;
            for(let sec of homeData) {
                const found = sec.books.find(b => b.id == id);
                if(found) return found;
            }
            return null;
        }
    </script>
</body>
</html>
