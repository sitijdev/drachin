<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dramabox Unofficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Custom Scrollbar ala Mobile */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #e50914; border-radius: 4px; }
        
        .poster-aspect { aspect-ratio: 2/3; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-black text-gray-100 font-sans antialiased pb-20">

    <nav class="fixed top-0 w-full bg-black/90 backdrop-blur z-50 border-b border-gray-800">
        <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-2xl font-bold text-red-600 tracking-tighter cursor-pointer" onclick="goHome()">
                <i class="fas fa-play-circle"></i> DRAMABOX
            </h1>
            <div id="loading-indicator" class="hidden">
                <i class="fas fa-circle-notch fa-spin text-white"></i>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto mt-16 min-h-screen">
        
        <div id="view-home" class="p-4">
            <div id="columns-container" class="space-y-8"></div>
        </div>

        <div id="view-detail" class="hidden bg-zinc-900 min-h-screen relative">
            <button onclick="goHome()" class="absolute top-4 left-4 z-10 bg-black/50 p-2 rounded-full text-white hover:bg-red-600 transition">
                <i class="fas fa-arrow-left"></i>
            </button>

            <div class="relative w-full h-64 overflow-hidden">
                <img id="detail-cover-bg" src="" class="w-full h-full object-cover opacity-30 blur-md">
                <div class="absolute inset-0 bg-gradient-to-t from-zinc-900 via-transparent to-transparent"></div>
            </div>

            <div class="px-5 -mt-20 relative flex gap-4">
                <img id="detail-cover" src="" class="w-32 rounded-lg shadow-2xl border border-gray-700 poster-aspect object-cover bg-gray-800">
                
                <div class="pt-24 flex-1">
                    <h2 id="detail-title" class="text-xl font-bold text-white leading-tight mb-1">Judul Drama</h2>
                    <div class="flex items-center text-xs text-gray-400 gap-3 mb-2">
                        <span><i class="fas fa-layer-group text-red-500"></i> <span id="detail-eps">0</span> Eps</span>
                        <span><i class="fas fa-eye text-red-500"></i> <span id="detail-views">0</span></span>
                    </div>
                </div>
            </div>

            <div class="px-5 mt-4">
                <p id="detail-desc" class="text-sm text-gray-400 line-clamp-3" onclick="this.classList.toggle('line-clamp-3')">
                    Deskripsi drama...
                </p>
            </div>

            <div class="p-5 pb-20">
                <h3 class="font-bold mb-4 text-lg border-l-4 border-red-600 pl-3">Episode List</h3>
                <div id="chapters-grid" class="grid grid-cols-4 sm:grid-cols-5 gap-3">
                    </div>
            </div>
        </div>

        <div id="view-player" class="hidden fixed inset-0 z-[100] bg-black flex flex-col justify-center items-center">
            <button onclick="closePlayer()" class="absolute top-4 left-4 text-white text-xl z-10 p-2 bg-black/50 rounded-full">
                <i class="fas fa-times"></i> Close
            </button>
            
            <div class="w-full max-w-4xl aspect-[9/16] sm:aspect-video bg-black relative">
                <video id="video-player" controls autoplay class="w-full h-full object-contain"></video>
            </div>
            <div class="mt-4 text-center px-4">
                <h4 id="player-title" class="text-lg font-semibold">Playing...</h4>
            </div>
        </div>

    </main>

    <script>
        const API_BASE = "/api/data";
        
        // Cache data drama di memory browser agar navigasi cepat
        let cachedData = null;

        // --- NAVIGATION FUNCTIONS ---

        function goHome() {
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('view-detail').classList.add('hidden');
            document.getElementById('view-player').classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function showLoading(show) {
            const el = document.getElementById('loading-indicator');
            if(show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        // --- HOME: LOAD DRAMA LIST ---

        async function loadHome() {
            if (cachedData) return renderHome(cachedData);

            showLoading(true);
            try {
                // Request ke Worker kita
                const res = await fetch(`${API_BASE}?type=list`);
                const json = await res.json();
                
                if (json.data && json.data.columnVoList) {
                    cachedData = json.data.columnVoList;
                    renderHome(cachedData);
                } else {
                    alert("Gagal memuat data (Format JSON berbeda)");
                    console.log(json);
                }
            } catch (e) {
                alert("Error Network: " + e.message);
            }
            showLoading(false);
        }

        function renderHome(columnList) {
            const container = document.getElementById('columns-container');
            container.innerHTML = '';

            columnList.forEach(col => {
                if (!col.bookList || col.bookList.length === 0) return;

                // Buat Section per Kategori
                const section = document.createElement('div');
                section.innerHTML = `
                    <h3 class="text-lg font-bold mb-3 px-2 border-l-4 border-red-600 ml-1">${col.title}</h3>
                    <div class="flex overflow-x-auto gap-4 px-2 pb-4 hide-scrollbar snap-x">
                        ${col.bookList.map(book => createBookCard(book)).join('')}
                    </div>
                `;
                container.appendChild(section);
            });

            // Event Listener untuk klik poster
            document.querySelectorAll('.book-card').forEach(card => {
                card.addEventListener('click', () => {
                    const bookData = JSON.parse(decodeURIComponent(card.dataset.book));
                    openDetail(bookData);
                });
            });
        }

        function createBookCard(book) {
            // Data buku disimpan di dataset attribute agar bisa diambil saat klik
            const bookString = encodeURIComponent(JSON.stringify(book));
            
            return `
                <div class="book-card flex-none w-32 sm:w-40 cursor-pointer snap-start transition hover:scale-105" data-book="${bookString}">
                    <div class="relative rounded-lg overflow-hidden poster-aspect bg-gray-800">
                        <img src="${book.cover}" loading="lazy" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'">
                        <div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg">
                            ${book.chapterCount} Eps
                        </div>
                    </div>
                    <div class="mt-2">
                        <h4 class="font-medium text-sm line-clamp-2 leading-snug text-gray-200">${book.bookName}</h4>
                    </div>
                </div>
            `;
        }

        // --- DETAIL: SHOW INFO & LOAD CHAPTERS ---

        async function openDetail(book) {
            // 1. Isi Info Statis (Judul, Gambar, Deskripsi) dari data List
            document.getElementById('detail-title').innerText = book.bookName;
            document.getElementById('detail-desc').innerText = book.introduction || "Tidak ada deskripsi.";
            document.getElementById('detail-cover').src = book.cover;
            document.getElementById('detail-cover-bg').src = book.cover;
            document.getElementById('detail-eps').innerText = book.chapterCount;
            document.getElementById('detail-views').innerText = book.playCount || "-";
            
            // Reset Grid
            const grid = document.getElementById('chapters-grid');
            grid.innerHTML = '<div class="col-span-full text-center py-10"><i class="fas fa-circle-notch fa-spin text-red-600 text-2xl"></i><p class="mt-2 text-gray-500">Memuat episode...</p></div>';

            // Ganti View
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            window.scrollTo(0, 0);

            // 2. Fetch Chapter List dari Backend
            try {
                const res = await fetch(`${API_BASE}?type=chapter&bookId=${book.bookId}`);
                const json = await res.json();

                grid.innerHTML = ''; // Clear loading

                if (json.data && json.data.chapterList) {
                    json.data.chapterList.forEach((ch, index) => {
                        // Cari link video
                        const cdn = ch.cdnList?.find(c => c.isDefault === 1) || ch.cdnList?.[0];
                        const vidUrl = cdn?.videoPathList?.find(v => v.isDefault === 1)?.videoPath;
                        const isLocked = !vidUrl; // Kalau null berarti dikunci (tapi script kita biasanya dapat semua krn token sakti)

                        const btn = document.createElement('button');
                        btn.className = `p-3 rounded-lg text-sm font-bold transition ${isLocked ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : 'bg-gray-800 hover:bg-red-600 text-white'}`;
                        btn.innerText = index + 1;
                        
                        if (!isLocked) {
                            btn.onclick = () => openPlayer(vidUrl, ch.chapterName);
                        }

                        grid.appendChild(btn);
                    });
                } else {
                    grid.innerHTML = '<p class="col-span-full text-center text-red-500">Gagal memuat episode.</p>';
                }

            } catch (e) {
                grid.innerHTML = `<p class="col-span-full text-center text-red-500">Error: ${e.message}</p>`;
            }
        }

        // --- PLAYER: VIDEO OVERLAY ---

        function openPlayer(url, title) {
            const playerView = document.getElementById('view-player');
            const video = document.getElementById('video-player');
            
            document.getElementById('player-title').innerText = title;
            video.src = url;
            playerView.classList.remove('hidden');
            video.play().catch(e => console.log("Auto-play blocked"));
        }

        function closePlayer() {
            const playerView = document.getElementById('view-player');
            const video = document.getElementById('video-player');
            
            video.pause();
            video.src = "";
            playerView.classList.add('hidden');
        }

        // Init
        loadHome();

    </script>
</body>
</html>
