<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dramabox Unofficial</title>
    <meta name="description" content="Nonton drama pendek sub Indo gratis.">
    <meta name="theme-color" content="#0f0f0f">

    <!-- ROUTE HANDLER: jika path dimulai dengan /player/ then load player/index.html content
         Menggunakan DOMParser + eksekusi skrip aman (module) supaya tidak terjadi document.write
         dan tidak mengeksekusi ulang Tailwind CDN/duplikat deklarasi global -->
    <script>
      (function(){
        try {
          if (!location.pathname.startsWith('/player/')) return;

          // ambil file player/index.html
          fetch('/player/index.html', { cache: 'no-store' })
            .then(resp => {
              if (!resp.ok) throw new Error('Gagal mengambil player page');
              return resp.text();
            })
            .then(html => {
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');

              // update title
              if (doc.title) document.title = doc.title;

              // copy meta/link/style dari head yang belum ada (jangan tambahkan cdn.tailwindcss.com lagi)
              const existingHead = document.head;
              doc.head && Array.from(doc.head.children).forEach(el => {
                // skip script tags for now (we'll handle scripts separately)
                if (el.tagName === 'SCRIPT') return;

                // For LINK tags: only add if same href not already present
                if (el.tagName === 'LINK') {
                  const href = el.getAttribute('href') || '';
                  if (!href) return;
                  // skip tailwind CDN link/script if exists in fetched doc
                  if (href.includes('cdn.tailwindcss.com')) return;
                  if (!existingHead.querySelector(`link[href="${href}"]`)) {
                    existingHead.appendChild(el.cloneNode(true));
                  }
                  return;
                }

                // For STYLE or META or other head elements, try to avoid duplicates
                if (el.tagName === 'STYLE' || el.tagName === 'META' || el.tagName === 'TITLE') {
                  // naive append: most pages won't duplicate harmful items
                  existingHead.appendChild(el.cloneNode(true));
                }
              });

              // replace body content
              document.body.innerHTML = doc.body.innerHTML;

              // execute scripts found in the fetched document (body & head if any)
              const runScripts = (container) => {
                Array.from(container.querySelectorAll('script')).forEach(s => {
                  // skip tailwind CDN if present as script tag
                  if (s.src && s.src.includes('cdn.tailwindcss.com')) return;

                  // If external src, append a regular script (will execute globally)
                  if (s.src) {
                    const newS = document.createElement('script');
                    newS.src = s.src;
                    // keep same async attribute behavior if present
                    if (s.hasAttribute('async')) newS.async = true;
                    document.body.appendChild(newS);
                  } else {
                    // inline script: execute as module to avoid polluting global scope
                    const inline = document.createElement('script');
                    inline.type = 'module';
                    // We place original content directly. Using module scope prevents top-level
                    // const/let/function conflicts with existing globals (fixes "already been declared").
                    inline.textContent = s.textContent || '';
                    document.body.appendChild(inline);
                  }
                });
              };

              // run scripts in head/body of fetched doc
              if (doc.head) runScripts(doc.head);
              if (doc.body) runScripts(doc.body);
            })
            .catch(err => {
              console.warn('Fallback: tidak bisa load player page, menampilkan beranda. Error:', err);
            });
        } catch (e) {
          console.error(e);
        }
      })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0f0f0f; color: #e5e5e5; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .aspect-poster { aspect-ratio: 2/3; }
        .glass-nav { background: rgba(0, 0, 0, 0.95); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .glass-bottom { background: rgba(0, 0, 0, 0.95); border-top: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        /* Animasi Skeleton */
        .skeleton { background: linear-gradient(90deg, #1f1f1f 25%, #2a2a2a 50%, #1f1f1f 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-24">

    <nav class="fixed top-0 w-full glass-nav z-50 h-14 flex items-center justify-between px-4">
        <div class="flex items-center">
            <a href="/" class="flex items-center gap-2 text-red-600">
                <i class="fas fa-play-circle text-2xl"></i>
                <span class="font-bold text-lg tracking-wide hidden sm:block">DRAMABOX</span>
            </a>
        </div>
        <div class="relative">
            <input type="text" id="search-input" placeholder="Cari drama..." 
                class="bg-zinc-800/80 border border-zinc-700/50 rounded-full px-4 py-1.5 text-sm focus:outline-none focus:border-red-600 transition w-36 sm:w-56 text-white placeholder-gray-500">
            <i class="fas fa-search absolute right-3 top-2 text-gray-500 text-xs pointer-events-none"></i>
        </div>
    </nav>

    <main id="app" class="flex-1 pt-16 px-3 sm:px-4 max-w-5xl mx-auto w-full min-h-screen"></main>

    <nav class="fixed bottom-0 w-full glass-bottom z-50 h-16 pb-safe">
        <div class="max-w-lg mx-auto h-full flex justify-around items-center px-2">
            <button onclick="switchTab('home')" class="nav-btn w-16 text-red-500" id="tab-home">
                <i class="fas fa-home text-xl mb-1"></i><br><span class="text-[10px]">Beranda</span>
            </button>
            <button onclick="switchTab('favorites')" class="nav-btn w-16 text-gray-500" id="tab-favorites">
                <i class="fas fa-heart text-xl mb-1"></i><br><span class="text-[10px]">Favorit</span>
            </button>
            <button onclick="switchTab('history')" class="nav-btn w-16 text-gray-500" id="tab-history">
                <i class="fas fa-clock-rotate-left text-xl mb-1"></i><br><span class="text-[10px]">Riwayat</span>
            </button>
            <button onclick="switchTab('account')" class="nav-btn w-16 text-gray-500" id="tab-account">
                <i class="fas fa-user text-xl mb-1"></i><br><span class="text-[10px]">Akun</span>
            </button>
        </div>
    </nav>

    <script>
        const API = "/api/data";
        let currentTab = 'home';
        let homeData = null;

        const getLS = (k) => JSON.parse(localStorage.getItem(k)||'{}');

        // FUNGSI GANTI TAB
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-btn').forEach(b => {
                const isActive = b.id === `tab-${tab}`;
                b.className = `nav-btn w-16 ${isActive ? 'text-red-500' : 'text-gray-500'}`;
            });
            render();
        }

        // FUNGSI RENDER UTAMA
        async function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            
            // --- TAB HOME ---
            if(currentTab === 'home') {
                if(!homeData) {
                    // Skeleton Loading
                    app.innerHTML = `
                        <div class="space-y-6 pt-4 animate-pulse">
                            <div class="h-6 w-32 bg-zinc-800 rounded skeleton"></div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="aspect-poster bg-zinc-800 rounded-lg skeleton"></div>
                                <div class="aspect-poster bg-zinc-800 rounded-lg skeleton"></div>
                                <div class="aspect-poster bg-zinc-800 rounded-lg skeleton"></div>
                            </div>
                        </div>`;
                    
                    try {
                        const res = await fetch(`${API}?type=list`);
                        const json = await res.json();
                        homeData = json.sections;
                        render(); 
                    } catch(e) { 
                        app.innerHTML = '<div class="text-center py-20 text-red-500">Gagal memuat data.</div>'; 
                    }
                    return;
                }
                
                if(homeData && homeData.length) {
                    homeData.forEach(sec => {
                        if(!sec.books.length) return;
                        app.innerHTML += `
                            <section class="mb-8 animate-fade-in">
                                <h2 class="text-lg font-bold text-white mb-4 border-l-4 border-red-600 pl-3">${sec.title}</h2>
                                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                                    ${sec.books.map(b => createCard(b)).join('')}
                                </div>
                            </section>`;
                    });
                } else {
                    app.innerHTML = '<div class="text-center py-20 text-gray-500">Tidak ada data drama.</div>';
                }
            } 
            
            // --- TAB FAVORIT & RIWAYAT ---
            else if(currentTab === 'favorites' || currentTab === 'history') {
                const key = currentTab === 'favorites' ? 'db_favs' : 'db_history';
                const data = Object.values(getLS(key)).sort((a,b) => b.timestamp - a.timestamp);
                app.innerHTML = `<h2 class="text-xl font-bold text-white mb-6 capitalize">${currentTab === 'favorites' ? 'Favorit Saya' : 'Riwayat Tontonan'}</h2>`;
                
                if(data.length === 0) {
                    app.innerHTML += `
                        <div class="text-center py-20 text-gray-500 flex flex-col items-center">
                            <i class="fas fa-ghost text-4xl mb-2 opacity-50"></i>
                            <p>Belum ada data.</p>
                            <button onclick="switchTab('home')" class="mt-4 px-4 py-2 bg-zinc-800 rounded-full text-xs text-white">Mulai Nonton</button>
                        </div>`;
                } else {
                    app.innerHTML += `<div class="grid grid-cols-3 sm:grid-cols-4 gap-3 animate-fade-in">${data.map(b => createCard(b, currentTab==='history')).join('')}</div>`;
                }
            }
            
            // --- TAB AKUN ---
            else {
                app.innerHTML = `
                    <div class="text-center py-20 text-gray-400 animate-fade-in">
                        <i class="fas fa-user-circle text-6xl mb-4 text-zinc-700"></i>
                        <h2 class="text-xl font-bold text-white">Pengguna Tamu</h2>
                        <p class="text-sm mt-2 text-gray-500">Data tersimpan di browser ini.</p>
                        <button onclick="if(confirm('Hapus semua data?')){localStorage.clear();location.reload()}" class="mt-8 px-6 py-2 bg-red-900/20 border border-red-900/50 rounded-lg text-red-500 text-sm hover:bg-red-900/40 transition">
                            <i class="fas fa-trash mr-2"></i> Hapus Data
                        </button>
                    </div>`;
            }
        }

        // FUNGSI MEMBUAT KARTU (LINK SEO FRIENDLY)
        function createCard(b, isHistory=false) {
            // Tentukan episode target: kalau ada history pakai lastEpisode, kalau tidak pakai 1
            let targetEp = 1;
            if (isHistory && b.lastEpisode) targetEp = b.lastEpisode;

            // Format URL: /player/BOOKID-CHAPTERID (Contoh: /player/1005-3)
            const url = `/player/${b.id}-${targetEp}`;
            
            return `
            <a href="${url}" class="block group relative transition transform active:scale-95">
                <div class="aspect-poster rounded-lg overflow-hidden bg-zinc-800 mb-2 relative border border-white/5 group-hover:border-red-600 transition">
                    <img src="${b.cover}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='https://via.placeholder.com/200x300'">
                    <div class="absolute top-1 right-1 bg-black/80 backdrop-blur text-[9px] px-1.5 py-0.5 rounded text-white font-bold shadow">${b.episodes||'?'} Eps</div>
                    ${isHistory ? `<div class="absolute bottom-0 left-0 w-full h-1 bg-gray-700"><div class="bg-red-600 h-full" style="width: ${(b.lastEpisode/(parseInt(b.episodes)||100))*100}%"></div></div>` : ''}
                </div>
                <h3 class="text-xs font-medium text-gray-300 line-clamp-2 group-hover:text-white leading-tight">${b.title}</h3>
            </a>`;
        }

        // Search Logic
        document.getElementById('search-input').addEventListener('keypress', async (e) => {
            if(e.key === 'Enter') {
                const q = e.target.value;
                const app = document.getElementById('app');
                app.innerHTML = '<div class="text-center py-20 text-gray-500"><i class="fas fa-circle-notch fa-spin"></i> Mencari...</div>';
                try {
                    const res = await fetch(`${API}?type=search&keyword=${encodeURIComponent(q)}`);
                    const json = await res.json();
                    homeData = json.sections; 
                    switchTab('home'); 
                } catch(e){ app.innerHTML='<div class="text-center py-20 text-red-500">Gagal mencari.</div>';}
            }
        });

        render();
    </script>
</body>
</html>
